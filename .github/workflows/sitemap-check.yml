name: ğŸ—ºï¸ SitemapæŒç»­éªŒè¯

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ main, master, develop ]
    paths:
      - 'src/app/**'
      - 'src/i18n/**'
      - 'src/middleware.ts'
      - 'src/app/sitemap.ts'
      - 'test/sitemap/**'
  
  # Pull Requestæ—¶è§¦å‘
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'src/app/**'
      - 'src/i18n/**'
      - 'src/middleware.ts'
      - 'src/app/sitemap.ts'
      - 'test/sitemap/**'
  
  # å®šæ—¶æ£€æŸ¥ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
  schedule:
    - cron: '0 2 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      validation_mode:
        description: 'éªŒè¯æ¨¡å¼'
        required: true
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - full
      include_performance:
        description: 'åŒ…å«æ€§èƒ½æµ‹è¯•'
        required: false
        default: true
        type: boolean

# æƒé™è®¾ç½®
permissions:
  contents: read
  issues: write
  pull-requests: write
  pages: write
  id-token: write

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # å¿«é€Ÿé™æ€åˆ†æå·¥ä½œ
  static-analysis:
    name: ğŸ“‹ é™æ€åˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      analysis-success: ${{ steps.static-check.outputs.success }}
      total-urls: ${{ steps.static-check.outputs.total-urls }}
      matched-urls: ${{ steps.static-check.outputs.matched-urls }}
      success-rate: ${{ steps.static-check.outputs.success-rate }}
    
    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ è®¾ç½®pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
        
      - name: ğŸ” æ‰§è¡Œé™æ€åˆ†æ
        id: static-check
        run: |
          echo "å¼€å§‹é™æ€åˆ†æ..."
          node test/sitemap/analyze_sitemap.js
          
          # è¯»å–åˆ†æç»“æœ
          if [ -f "test/sitemap/sitemap_404_diagnosis.json" ]; then
            TOTAL_URLS=$(node -e "console.log(require('./test/sitemap/sitemap_404_diagnosis.json').summary.totalUrls)")
            MATCHED_URLS=$(node -e "console.log(require('./test/sitemap/sitemap_404_diagnosis.json').summary.matched)")
            SUCCESS_RATE=$(node -e "console.log(require('./test/sitemap/sitemap_404_diagnosis.json').summary.successRate)")
            
            echo "total-urls=$TOTAL_URLS" >> $GITHUB_OUTPUT
            echo "matched-urls=$MATCHED_URLS" >> $GITHUB_OUTPUT
            echo "success-rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
            
            # åˆ¤æ–­æ˜¯å¦æˆåŠŸï¼ˆæˆåŠŸç‡ >= 95%ï¼‰
            SUCCESS_RATE_NUM=$(echo $SUCCESS_RATE | sed 's/%//')
            if [ $(echo "$SUCCESS_RATE_NUM >= 95" | bc -l) -eq 1 ]; then
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "success=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "total-urls=0" >> $GITHUB_OUTPUT
            echo "matched-urls=0" >> $GITHUB_OUTPUT
            echo "success-rate=0%" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ“¤ ä¸Šä¼ é™æ€åˆ†ææŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: static-analysis-report
          path: |
            test/sitemap/sitemap_404_diagnosis.json
            test/sitemap/sitemap_urls.txt
          retention-days: 30

  # HTTPéªŒè¯å·¥ä½œ
  http-validation:
    name: ğŸŒ HTTPéªŒè¯
    runs-on: ubuntu-latest
    needs: static-analysis
    if: needs.static-analysis.outputs.analysis-success == 'true' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 20
    
    outputs:
      validation-success: ${{ steps.http-check.outputs.success }}
      http-success-rate: ${{ steps.http-check.outputs.success-rate }}
      failed-urls: ${{ steps.http-check.outputs.failed-urls }}
    
    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ è®¾ç½®pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
        
      - name: ğŸš€ æ„å»ºé¡¹ç›®
        run: pnpm build
        
      - name: ğŸŒ æ‰§è¡ŒHTTPéªŒè¯
        id: http-check
        run: |
          echo "å¼€å§‹HTTPéªŒè¯..."
          
          # é€‰æ‹©éªŒè¯æ¨¡å¼
          VALIDATION_MODE="${{ github.event.inputs.validation_mode || 'standard' }}"
          node test/sitemap/continuous-validation.js $VALIDATION_MODE --verbose
          
          # è¯»å–éªŒè¯ç»“æœ
          if [ -f "test/sitemap/reports/latest-$VALIDATION_MODE.json" ]; then
            HTTP_SUCCESS_RATE=$(node -e "
              const report = require('./test/sitemap/reports/latest-$VALIDATION_MODE.json');
              console.log(report.summary?.validation?.httpSuccessRate || 0);
            ")
            
            FAILED_URLS=$(node -e "
              const report = require('./test/sitemap/reports/latest-$VALIDATION_MODE.json');
              const failures = report.httpValidation?.filter(r => !r.success) || [];
              console.log(failures.length);
            ")
            
            echo "success-rate=$HTTP_SUCCESS_RATE" >> $GITHUB_OUTPUT
            echo "failed-urls=$FAILED_URLS" >> $GITHUB_OUTPUT
            
            # åˆ¤æ–­æ˜¯å¦æˆåŠŸï¼ˆæˆåŠŸç‡ >= 95%ï¼‰
            if [ $(echo "$HTTP_SUCCESS_RATE >= 95" | bc -l) -eq 1 ]; then
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "success=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "success-rate=0" >> $GITHUB_OUTPUT
            echo "failed-urls=unknown" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ“¤ ä¸Šä¼ HTTPéªŒè¯æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: http-validation-report
          path: |
            test/sitemap/reports/
          retention-days: 30

  # æ€§èƒ½ç›‘æ§å·¥ä½œ
  performance-test:
    name: âš¡ æ€§èƒ½ç›‘æ§
    runs-on: ubuntu-latest
    needs: [static-analysis, http-validation]
    if: |
      (needs.http-validation.outputs.validation-success == 'true' && 
       (github.event.inputs.include_performance != 'false' || github.event_name == 'schedule')) ||
      github.event.inputs.validation_mode == 'full'
    timeout-minutes: 30
    
    outputs:
      performance-score: ${{ steps.perf-check.outputs.score }}
      performance-rating: ${{ steps.perf-check.outputs.rating }}
      avg-response-time: ${{ steps.perf-check.outputs.avg-response-time }}
    
    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ è®¾ç½®pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
        
      - name: ğŸš€ æ„å»ºé¡¹ç›®
        run: pnpm build
        
      - name: âš¡ æ‰§è¡Œæ€§èƒ½ç›‘æ§
        id: perf-check
        run: |
          echo "å¼€å§‹æ€§èƒ½ç›‘æ§..."
          
          # å‡†å¤‡URLåˆ—è¡¨
          if [ ! -f "test/sitemap/sitemap_urls.txt" ]; then
            node test/sitemap/analyze_sitemap.js
          fi
          
          # è¿è¡Œæ€§èƒ½ç›‘æ§
          node test/sitemap/performance-monitor.js --verbose
          
          # è¯»å–æ€§èƒ½ç»“æœ
          if [ -f "test/sitemap/performance-reports/latest-performance.json" ]; then
            PERF_SCORE=$(node -e "
              const report = require('./test/sitemap/performance-reports/latest-performance.json');
              console.log(report.summary?.overall?.score || 0);
            ")
            
            PERF_RATING=$(node -e "
              const report = require('./test/sitemap/performance-reports/latest-performance.json');
              console.log(report.summary?.overall?.rating || 'UNKNOWN');
            ")
            
            AVG_RESPONSE_TIME=$(node -e "
              const report = require('./test/sitemap/performance-reports/latest-performance.json');
              console.log(report.summary?.baseline?.averageResponseTime || 0);
            ")
            
            echo "score=$PERF_SCORE" >> $GITHUB_OUTPUT
            echo "rating=$PERF_RATING" >> $GITHUB_OUTPUT
            echo "avg-response-time=$AVG_RESPONSE_TIME" >> $GITHUB_OUTPUT
          else
            echo "score=0" >> $GITHUB_OUTPUT
            echo "rating=FAILED" >> $GITHUB_OUTPUT
            echo "avg-response-time=0" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ“¤ ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-reports
          path: |
            test/sitemap/performance-reports/
          retention-days: 30

  # ç”Ÿæˆç»¼åˆæŠ¥å‘Š
  generate-report:
    name: ğŸ“Š ç”Ÿæˆç»¼åˆæŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [static-analysis, http-validation, performance-test]
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts/
          
      - name: ğŸ“Š ç”Ÿæˆç»¼åˆæŠ¥å‘Š
        run: |
          echo "# ğŸ—ºï¸ SitemapéªŒè¯æŠ¥å‘Š" > sitemap-report.md
          echo "" >> sitemap-report.md
          echo "**éªŒè¯æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> sitemap-report.md
          echo "**è§¦å‘äº‹ä»¶**: ${{ github.event_name }}" >> sitemap-report.md
          echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> sitemap-report.md
          echo "**æäº¤**: ${{ github.sha }}" >> sitemap-report.md
          echo "" >> sitemap-report.md
          
          # é™æ€åˆ†æç»“æœ
          echo "## ğŸ“‹ é™æ€åˆ†æ" >> sitemap-report.md
          echo "- **æ€»URLæ•°**: ${{ needs.static-analysis.outputs.total-urls }}" >> sitemap-report.md
          echo "- **åŒ¹é…URLæ•°**: ${{ needs.static-analysis.outputs.matched-urls }}" >> sitemap-report.md
          echo "- **æˆåŠŸç‡**: ${{ needs.static-analysis.outputs.success-rate }}" >> sitemap-report.md
          echo "" >> sitemap-report.md
          
          # HTTPéªŒè¯ç»“æœ
          if [ "${{ needs.http-validation.result }}" != "skipped" ]; then
            echo "## ğŸŒ HTTPéªŒè¯" >> sitemap-report.md
            echo "- **HTTPæˆåŠŸç‡**: ${{ needs.http-validation.outputs.http-success-rate }}%" >> sitemap-report.md
            echo "- **å¤±è´¥URLæ•°**: ${{ needs.http-validation.outputs.failed-urls }}" >> sitemap-report.md
            echo "" >> sitemap-report.md
          fi
          
          # æ€§èƒ½ç›‘æ§ç»“æœ
          if [ "${{ needs.performance-test.result }}" != "skipped" ]; then
            echo "## âš¡ æ€§èƒ½ç›‘æ§" >> sitemap-report.md
            echo "- **æ€§èƒ½è¯„åˆ†**: ${{ needs.performance-test.outputs.performance-score }}/100" >> sitemap-report.md
            echo "- **æ€§èƒ½è¯„çº§**: ${{ needs.performance-test.outputs.performance-rating }}" >> sitemap-report.md
            echo "- **å¹³å‡å“åº”æ—¶é—´**: ${{ needs.performance-test.outputs.avg-response-time }}ms" >> sitemap-report.md
            echo "" >> sitemap-report.md
          fi
          
          # æ€»ä½“çŠ¶æ€
          echo "## ğŸ¯ æ€»ä½“çŠ¶æ€" >> sitemap-report.md
          if [ "${{ needs.static-analysis.outputs.analysis-success }}" == "true" ] && 
             [ "${{ needs.http-validation.outputs.validation-success }}" == "true" ]; then
            echo "âœ… **çŠ¶æ€**: é€šè¿‡" >> sitemap-report.md
          else
            echo "âŒ **çŠ¶æ€**: å¤±è´¥" >> sitemap-report.md
          fi
          
      - name: ğŸ“¤ ä¸Šä¼ ç»¼åˆæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: sitemap-comprehensive-report
          path: sitemap-report.md
          retention-days: 30

  # PRè¯„è®º
  comment-pr:
    name: ğŸ’¬ PRè¯„è®º
    runs-on: ubuntu-latest
    needs: [static-analysis, http-validation, performance-test]
    if: github.event_name == 'pull_request' && always()
    
    steps:
      - name: ğŸ’¬ è¯„è®ºPR
        uses: actions/github-script@v7
        with:
          script: |
            const staticSuccess = '${{ needs.static-analysis.outputs.analysis-success }}' === 'true';
            const httpSuccess = '${{ needs.http-validation.outputs.validation-success }}' === 'true';
            const staticRate = '${{ needs.static-analysis.outputs.success-rate }}';
            const httpRate = '${{ needs.http-validation.outputs.http-success-rate }}';
            const totalUrls = '${{ needs.static-analysis.outputs.total-urls }}';
            
            const statusIcon = (staticSuccess && httpSuccess) ? 'âœ…' : 'âŒ';
            const performanceData = '${{ needs.performance-test.outputs.performance-score }}' !== '' 
              ? `\nâš¡ **æ€§èƒ½è¯„åˆ†**: ${{ needs.performance-test.outputs.performance-score }}/100 (${{ needs.performance-test.outputs.performance-rating }})`
              : '';
            
            const comment = `## ${statusIcon} SitemapéªŒè¯ç»“æœ
            
            ğŸ“‹ **é™æ€åˆ†æ**: ${staticRate} (${totalUrls} URLs)
            ğŸŒ **HTTPéªŒè¯**: ${httpRate}% æˆåŠŸ${performanceData}
            
            ${(staticSuccess && httpSuccess) 
              ? 'ğŸ‰ æ‰€æœ‰sitemap URLéªŒè¯é€šè¿‡ï¼' 
              : 'âš ï¸  å‘ç°sitemapé—®é¢˜ï¼Œè¯·æ£€æŸ¥è¯¦ç»†æŠ¥å‘Šã€‚'}
            
            ğŸ“Š [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](${context.payload.pull_request.html_url}/checks)`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # åˆ›å»ºIssueï¼ˆå¦‚æœéªŒè¯å¤±è´¥ï¼‰
  create-issue:
    name: ğŸš¨ åˆ›å»ºé—®é¢˜Issue
    runs-on: ubuntu-latest
    needs: [static-analysis, http-validation]
    if: |
      (needs.static-analysis.outputs.analysis-success != 'true' || 
       needs.http-validation.outputs.validation-success != 'true') &&
      github.event_name == 'schedule'
    
    steps:
      - name: ğŸš¨ åˆ›å»ºIssue
        uses: actions/github-script@v7
        with:
          script: |
            const staticSuccess = '${{ needs.static-analysis.outputs.analysis-success }}' === 'true';
            const httpSuccess = '${{ needs.http-validation.outputs.validation-success }}' === 'true';
            const staticRate = '${{ needs.static-analysis.outputs.success-rate }}';
            const httpRate = '${{ needs.http-validation.outputs.http-success-rate }}';
            
            const issues = [];
            if (!staticSuccess) issues.push(`é™æ€åˆ†æå¤±è´¥ (${staticRate})`);
            if (!httpSuccess) issues.push(`HTTPéªŒè¯å¤±è´¥ (${httpRate}%)`);
            
            const title = `ğŸš¨ SitemapéªŒè¯å¤±è´¥ - ${new Date().toISOString().split('T')[0]}`;
            const body = `## ğŸ—ºï¸ SitemapéªŒè¯å¤±è´¥æŠ¥å‘Š
            
            **æ£€æµ‹æ—¶é—´**: ${new Date().toISOString()}
            **è§¦å‘æ–¹å¼**: å®šæ—¶æ£€æŸ¥
            
            ### ğŸ” é—®é¢˜è¯¦æƒ…
            ${issues.map(issue => `- âŒ ${issue}`).join('\n')}
            
            ### ğŸ“Š è¯¦ç»†æ•°æ®
            - **é™æ€åˆ†ææˆåŠŸç‡**: ${staticRate}
            - **HTTPéªŒè¯æˆåŠŸç‡**: ${httpRate}%
            
            ### ğŸ› ï¸ ä¿®å¤å»ºè®®
            1. æ£€æŸ¥ \`src/app/sitemap.ts\` é…ç½®
            2. éªŒè¯é¡µé¢æ–‡ä»¶ç»“æ„æ˜¯å¦åŒ¹é…
            3. æ£€æŸ¥ä¸­é—´ä»¶è·¯ç”±é…ç½®
            4. è¿è¡Œæœ¬åœ°éªŒè¯: \`pnpm test:sitemap:full\`
            
            ### ğŸ“‹ ç›¸å…³æ–‡ä»¶
            - \`test/sitemap/TESTING_GUIDE.md\` - å®Œæ•´æµ‹è¯•æŒ‡å—
            - \`test/sitemap/continuous-validation.js\` - éªŒè¯è„šæœ¬
            
            /label bug,sitemap,urgent
            /assign @${context.repo.owner}`;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼çš„å¼€æ”¾Issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'sitemap',
              state: 'open'
            });
            
            const hasOpenSitemapIssue = existingIssues.data.some(issue => 
              issue.title.includes('SitemapéªŒè¯å¤±è´¥')
            );
            
            if (!hasOpenSitemapIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'sitemap', 'urgent']
              });
            }

  # éƒ¨ç½²æŠ¥å‘Šåˆ°GitHub Pagesï¼ˆå¯é€‰ï¼‰
  deploy-reports:
    name: ğŸŒ éƒ¨ç½²æŠ¥å‘Šåˆ°Pages
    runs-on: ubuntu-latest
    needs: [generate-report, performance-test]
    if: |
      github.event_name == 'schedule' && 
      needs.performance-test.result == 'success' &&
      github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ ä¸‹è½½æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          name: performance-reports
          path: ./reports/
          
      - name: ğŸŒ éƒ¨ç½²åˆ°GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports/
          destination_dir: sitemap-reports
          keep_files: true